<Window x:Class="Casino.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Multiplayer Poker" Width="1200" Height="800"
        Background="#102017">
    <Window.Resources>
        <SolidColorBrush x:Key="TableGreen" Color="#0F6A3D"/>
        <SolidColorBrush x:Key="TableEdge" Color="#083825"/>
        <SolidColorBrush x:Key="CardBack" Color="#FF2A2A2A"/>
        <SolidColorBrush x:Key="CardFace" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="Accent" Color="#FFD48E32"/>
        <SolidColorBrush x:Key="TextPrimary" Color="#FFECECEC"/>
        <SolidColorBrush x:Key="TextSecondary" Color="#FFB9B9B9"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="250"/>
        </Grid.RowDefinitions>

        <!-- HEADER: crear / unirse a mesa -->
        <DockPanel Grid.Row="0" Margin="8" LastChildFill="False">
            <!-- Info jugador -->
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                <TextBlock Text="Jokalaria:" Foreground="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding LocalPlayerName}" Foreground="{StaticResource TextPrimary}" Margin="6,0,0,0" VerticalAlignment="Center"/>

                <!-- NUEVO: fichas del jugador local siempre visibles -->
                <TextBlock Text=" | Fichak:" Foreground="{StaticResource TextSecondary}" Margin="12,0,0,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding LocalChips}" Foreground="{StaticResource TextPrimary}" Margin="4,0,0,0" VerticalAlignment="Center"/>

                <TextBlock Text=" | Uneko mahaia:" Foreground="{StaticResource TextSecondary}" Margin="12,0,0,0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding CurrentTableName}"
                           Foreground="{StaticResource TextPrimary}"
                           Margin="4,0,0,0"
                           VerticalAlignment="Center"
                           Visibility="{Binding IsInTable, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                <!-- (ninguna) visible solo si NO estas en mesa -->
                <TextBlock Text="(bat ere ez)"
                           Foreground="{StaticResource TextSecondary}"
                           Margin="4,0,0,0"
                           VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsInTable}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>

            <!-- Crear / Unirse a mesa -->
            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                <TextBlock Text="Mahai izena:" Foreground="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                <TextBox Width="180"
                         Margin="8,0,0,0"
                         Text="{Binding TableName, UpdateSourceTrigger=PropertyChanged}"
                         ToolTip="Mahaiaren izena" />
                <Button Content="Mahai berria"
                        Margin="8,0,0,0"
                        Command="{Binding CreateTableCommand}" />
                <Button Content="Sartu"
                        Margin="4,0,0,0"
                        Command="{Binding JoinTableCommand}" />
                <Button Content="Mahaitik atera"
                        Margin="8,0,0,0"
                        Command="{Binding LeaveTableCommand}" />

                <!-- Botón estadísticas con texto dinámico -->
                <Button Content="{Binding StatsButtonText}"
                        Margin="8,0,0,0"
                        Command="{Binding ShowHistoryCommand}" />
            </StackPanel>
        </DockPanel>

        <!-- MAIN TABLE AREA (visible cuando juego empezó y NO estamos en estadísticas) -->
        <Grid Grid.Row="1" Margin="12">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsGameStarted}" Value="True"/>
                                <Condition Binding="{Binding IsShowingStats}" Value="False"/>
                            </MultiDataTrigger.Conditions>
                            <Setter Property="Visibility" Value="Visible"/>
                        </MultiDataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>
            <!-- (mesa actual como la tienes) -->
            <Border Background="{StaticResource TableGreen}" CornerRadius="50" Padding="20" BorderBrush="{StaticResource TableEdge}" BorderThickness="8">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Player seats surrounding the table -->
                    <ItemsControl Grid.Row="0" ItemsSource="{Binding PlayerSeats}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="6" Background="#162A24" Padding="8" CornerRadius="4">
                                    <StackPanel>
                                        <TextBlock Text="{Binding DisplayName}" Foreground="{StaticResource TextPrimary}" />
                                        <TextBlock Text="{Binding Chips, StringFormat=Fichak: {0}}" Foreground="{StaticResource TextSecondary}" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Center area: pot + cartas O estadísticas -->
                    <StackPanel Grid.Row="1"
                                Orientation="Vertical"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">

                        <!-- Pot -->
                        <TextBlock Text="{Binding Pot, StringFormat=Potea: {0}}"
                                   Foreground="{StaticResource TextPrimary}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>

                        <!-- Community cards -->
                        <ItemsControl ItemsSource="{Binding CommunityCards}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Width="70" Height="100" CornerRadius="8" Padding="8" Margin="6" Background="{StaticResource CardFace}">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="8" ShadowDepth="3" Opacity="0.35"/>
                                        </Border.Effect>
                                        <Grid>
                                            <Border CornerRadius="8" BorderBrush="#33000000" BorderThickness="1"/>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Rank}" Foreground="Black" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Suit}" Foreground="Black"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Phase -->
                        <TextBlock Text="{Binding PhaseText}" Foreground="{StaticResource TextSecondary}" HorizontalAlignment="Center" Margin="0,8,0,0"/>

                        <!-- Local player's hole cards -->
                        <TextBlock Text="Zure kartak:" Foreground="{StaticResource TextSecondary}" HorizontalAlignment="Center" Margin="0,12,0,4"/>

                        <ItemsControl ItemsSource="{Binding LocalSeat.HoleCards}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Width="70" Height="100" CornerRadius="8" Padding="8" Margin="6" Background="{StaticResource CardFace}">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="8" ShadowDepth="3" Opacity="0.35"/>
                                        </Border.Effect>
                                        <Grid>
                                            <Border CornerRadius="8" BorderBrush="#33000000" BorderThickness="1"/>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Rank}" Foreground="Black" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Suit}" Foreground="Black"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                    </StackPanel>

                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="{Binding SmallBlind, StringFormat=SB: {0}}" Foreground="{StaticResource TextSecondary}" Margin="0,0,16,0"/>
                        <TextBlock Text="{Binding BigBlind, StringFormat=BB: {0}}" Foreground="{StaticResource TextSecondary}" Margin="0,0,16,0"/>
                        <TextBlock Text="{Binding HandNumber, StringFormat=Esku #{0}}" Foreground="{StaticResource TextSecondary}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- AREA DE ESPERA/READY cuando estas en mesa pero la partida no ha empezado -->
        <Border Grid.Row="1" Margin="12"
                Visibility="{Binding IsWaitingForReady, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="{Binding CurrentTableName, StringFormat=Mahai: {0}}"
                           Foreground="{StaticResource TextPrimary}"
                           FontSize="18"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"/>

                <!-- SOLO MultiBinding, sin atributo Text al nivel superior -->
                <TextBlock Foreground="{StaticResource TextSecondary}"
                           FontSize="14"
                           Margin="0,8,0,0"
                           HorizontalAlignment="Center">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0}/{1} jokalari prest">
                            <Binding Path="ReadyPlayers"/>
                            <Binding Path="TotalPlayers"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>

                <Button Content="Prest"
                        Command="{Binding ToggleReadyCommand}"
                        MinWidth="120"
                        Margin="0,16,0,0"
                        HorizontalAlignment="Center"/>

                <TextBlock Text="Jokalari guztiak prest egon arte itxaroten..."
                           Foreground="{StaticResource TextSecondary}"
                           Margin="0,12,0,0"
                           HorizontalAlignment="Center"
                           TextWrapping="Wrap"/>
            </StackPanel>
        </Border>

        <!-- Texto cuando NO estas en mesa -->
        <Border Grid.Row="1" Margin="12">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsInTable}" Value="True">
                            <Setter Property="Visibility" Value="Collapsed"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <TextBlock Text="Ez zaude inolako mahaitan. Goiko panelean mahai berria sor dezakezu edo existitzen den batera sartu."
               Foreground="{StaticResource TextPrimary}"
               FontSize="16"
               HorizontalAlignment="Center"
               VerticalAlignment="Center"
               TextWrapping="Wrap"
               TextAlignment="Center"/>
        </Border>

        <!-- Action controls (solo si estas en mesa) -->
        <Border Grid.Row="2" Padding="10" Background="#131F1B" BorderBrush="#2B3F38" BorderThickness="1"
                Visibility="{Binding IsInTable, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="3*"/>
                    <ColumnDefinition Width="2*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Zure txanda:" Foreground="{StaticResource TextSecondary}"/>
                    <Ellipse Width="14" Height="14" Fill="{StaticResource Accent}"
                             Visibility="{Binding IsLocalTurn, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="8,0,0,0"/>
                    <TextBlock Text="{Binding TurnCountdown, StringFormat={}{0}s}"
                               Foreground="{StaticResource TextSecondary}" Margin="8,0,0,0"/>

                    <!-- NUEVO: fichas del jugador local -->
                    <TextBlock Text=" | Zure fichak:" Foreground="{StaticResource TextSecondary}" Margin="12,0,0,0"/>
                    <TextBlock Text="{Binding LocalChips}"
                               Foreground="{StaticResource TextPrimary}"
                               FontWeight="Bold"
                               Margin="4,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="Fold" Command="{Binding FoldCommand}" MinWidth="90" Margin="8,0,0,0"/>
                    <Button Content="{Binding CheckOrCallText}" Command="{Binding CheckOrCallCommand}" MinWidth="110" Margin="8,0,0,0"/>
                    <Button Content="{Binding BetOrRaiseText}" Command="{Binding BetOrRaiseCommand}" MinWidth="110" Margin="8,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <TextBlock Text="Kopurua:" Foreground="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                    <Slider Width="240" Minimum="{Binding MinBet}" Maximum="{Binding MaxBet}" Value="{Binding BetAmount, Mode=TwoWay}" TickFrequency="1" IsSnapToTickEnabled="True" Margin="8,0,0,0"/>
                    <TextBox Width="80" Text="{Binding BetAmount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Margin="8,0,0,0"/>
                    <Button Content="Gehienez" Command="{Binding SetMaxBetCommand}" Margin="8,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- FILA 3: o CHAT a ancho completo o ESTADÍSTICAS a ancho completo -->
        <Grid Grid.Row="3">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- CHAT (ocupa todo el ancho cuando NO estamos en estadísticas) -->
            <Grid Grid.Row="0">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsShowingStats}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <GroupBox Header="Txata" Margin="8">
                    <Border Padding="8">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding ChatMessages}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="0,2">
                                            <TextBlock Text="{Binding Sender}" Foreground="{StaticResource Accent}" FontWeight="SemiBold"/>
                                            <TextBlock Text=": " Foreground="{StaticResource TextSecondary}"/>
                                            <TextBlock Text="{Binding Message}" Foreground="{StaticResource TextPrimary}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                </GroupBox>
            </Grid>

            <DockPanel Grid.Row="1" Margin="8" LastChildFill="True">
                <DockPanel.Style>
                    <Style TargetType="DockPanel">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsShowingStats}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DockPanel.Style>

                <TextBox DockPanel.Dock="Left"
                         Text="{Binding ChatInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                <Button Content="Bidali"
                        Command="{Binding SendChatCommand}"
                        Width="120"
                        Margin="8,0,0,0"/>
            </DockPanel>

            <!-- ESTADÍSTICAS / HISTORIAL (ocupa todo el ancho cuando SÍ estamos en estadísticas) -->
            <Grid Grid.Row="0">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsShowingStats}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <GroupBox Header="Esku-historiala" Margin="8">
                    <Border Padding="8">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <DataGrid ItemsSource="{Binding HandHistory}"
                                      AutoGenerateColumns="False"
                                      IsReadOnly="True"
                                      HeadersVisibility="Column"
                                      CanUserAddRows="False"
                                      CanUserDeleteRows="False"
                                      CanUserReorderColumns="False"
                                      CanUserResizeRows="False"
                                      GridLinesVisibility="Horizontal"
                                      Background="Transparent"
                                      Foreground="Black">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Data"
                                                        Binding="{Binding CreatedAt, StringFormat={}{0:dd/MM HH:mm}}"
                                                        Width="120"/>
                                    <DataGridTextColumn Header="Mahai"
                                                        Binding="{Binding TableName}"
                                                        Width="*"/>
                                    <DataGridTextColumn Header="Eskua"
                                                        Binding="{Binding HoleCards}"
                                                        Width="100"/>
                                    <DataGridTextColumn Header="Boarda"
                                                        Binding="{Binding BoardCards}"
                                                        Width="150"/>
                                    <DataGridTextColumn Header="Net"
                                                        Binding="{Binding Net}"
                                                        Width="70"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </ScrollViewer>
                    </Border>
                </GroupBox>
            </Grid>
        </Grid>

        <!-- PANEL ESTADÍSTICAS GENERALES EN EL CENTRO -->
        <Border Grid.Row="1" Margin="12"
                Background="{StaticResource TableGreen}"
                CornerRadius="30"
                Padding="24"
                BorderBrush="{StaticResource TableEdge}"
                BorderThickness="6"
                Visibility="{Binding IsShowingStats, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Estatistika orokorrak"
                           FontSize="22"
                           FontWeight="Bold"
                           Foreground="{StaticResource TextPrimary}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,12"/>

                <StackPanel Grid.Row="1" Orientation="Vertical" HorizontalAlignment="Center">
                    <!-- Resumen y winrate -->
                    <TextBlock Text="{Binding StatsSummary}"
                               Foreground="{StaticResource TextPrimary}"
                               FontSize="16"
                               Margin="0,0,0,8"
                               TextAlignment="Center"/>

                    <TextBlock Text="{Binding WinRateText}"
                               Foreground="{StaticResource TextSecondary}"
                               FontSize="14"
                               Margin="0,0,0,8"
                               TextAlignment="Center"/>

                    <TextBlock Text="{Binding MostPlayedRanksText}"
                               Foreground="{StaticResource TextSecondary}"
                               FontSize="14"
                               Margin="0,0,0,4"
                               TextAlignment="Center"/>

                    <TextBlock Text="{Binding MostPlayedHandsText}"
                               Foreground="{StaticResource TextSecondary}"
                               FontSize="14"
                               Margin="0,0,0,12"
                               TextAlignment="Center"/>

                    <Button Content="PDFra inprimatu"
                            Command="{Binding ExportStatsCommand}"
                            Margin="0,0,0,12"
                            Width="180"
                            HorizontalAlignment="Center"/>

                    <!-- Si luego añades más métricas, añádelas aquí -->
                    <ItemsControl ItemsSource="{Binding HandHistory}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Foreground="{StaticResource TextSecondary}"
                                           FontSize="12"
                                           Text="{Binding CreatedAt, StringFormat={}{0:dd/MM HH:mm}}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Grid>
        </Border>

        <TextBlock Grid.Row="0"
                   Margin="8,32,8,0"
                   HorizontalAlignment="Center"
                   Foreground="{StaticResource TextSecondary}"
                   Text="{Binding StatusMessage}"
                   TextWrapping="Wrap"/>
    </Grid>
</Window>
